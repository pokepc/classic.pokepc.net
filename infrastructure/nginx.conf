# nginx/nginx.conf
worker_processes auto;
events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;

  #──────────────────────────────────────────────────────────────
  # TCP optimizations
  #──────────────────────────────────────────────────────────────
  sendfile on;
  tcp_nodelay on;
  tcp_nopush on;
  types_hash_max_size 2048;

  #──────────────────────────────────────────────────────────────
  # GZIP compression
  #──────────────────────────────────────────────────────────────
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_vary on;
  gzip_types
    text/plain text/css text/javascript application/javascript application/x-javascript
    application/json application/xml image/svg+xml image/x-icon;

  server_tokens off;

  #──────────────────────────────────────────────────────────────
  # Timeouts
  #──────────────────────────────────────────────────────────────
  client_body_timeout 30s; # default is 60s
  client_header_timeout 30s; # default is 60s
  keepalive_timeout 60; # default is 65s
  send_timeout 30s; # default is 60s
  reset_timedout_connection on; # default is off

  #──────────────────────────────────────────────────────────────
  # Buffers
  #──────────────────────────────────────────────────────────────
  client_max_body_size 10m; # default is 1m
  client_body_buffer_size 32k; # default is 16k
  client_body_in_single_buffer off; # default is off
  client_header_buffer_size 1k; # default is 1k
  large_client_header_buffers 4 8k; # default is 4 8k

  # proxy_buffer_size 128k; # default is 16k
  # proxy_buffers 4 256k; # default is 8 16k
  # proxy_busy_buffers_size 256k; # default is 16k

  #──────────────────────────────────────────────────────────────
  # Cloudflare real IP restoration from: https://www.cloudflare.com/ips-v4 and ips-v6. Keep this updated occasionally
  #──────────────────────────────────────────────────────────────
  set_real_ip_from 173.245.48.0/20;
  set_real_ip_from 103.21.244.0/22;
  set_real_ip_from 103.22.200.0/22;
  set_real_ip_from 103.31.4.0/22;
  set_real_ip_from 141.101.64.0/18;
  set_real_ip_from 108.162.192.0/18;
  set_real_ip_from 190.93.240.0/20;
  set_real_ip_from 188.114.96.0/20;
  set_real_ip_from 197.234.240.0/22;
  set_real_ip_from 198.41.128.0/17;
  set_real_ip_from 162.158.0.0/15;
  set_real_ip_from 104.16.0.0/13;
  set_real_ip_from 104.24.0.0/14;
  set_real_ip_from 172.64.0.0/13;
  set_real_ip_from 131.0.72.0/22;

  real_ip_header CF-Connecting-IP;
  real_ip_recursive on;

  #──────────────────────────────────────────────────────────────
  # Anti DDoS (cloudflare-compatible) setting connection and request limits (2000 req/s per IP)
  #  - disable if you have a better anti-ddos solution (like Cloudflare)
  #──────────────────────────────────────────────────────────────
  # limit_conn_status 429;
  # limit_conn_zone $http_cf_connecting_ip zone=ip_lim_conn:20m;

  # limit_req_status 429;
  # limit_req_zone $http_cf_connecting_ip zone=ip_lim_req:10m rate=2000r/s;

  #──────────────────────────────────────────────────────────────
  # Upstream SSR app replicas (static list)
  #  - disable if you only have one instance of the app
  #──────────────────────────────────────────────────────────────
  # upstream ssr_app {
  #   least_conn;
  #   #upstream-servers-start
  #   server localhost:3000 max_fails=3 fail_timeout=10s;
  #   #upstream-servers-end
  #   keepalive 64;
  # }

  #──────────────────────────────────────────────────────────────
  # Log format
  #──────────────────────────────────────────────────────────────
  log_format custom_with_time '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" '
                            '${request_time}ms ${upstream_response_time}ms';

  #──────────────────────────────────────────────────────────────
  # Include other config files
  #──────────────────────────────────────────────────────────────
  # include /etc/nginx/conf.d/*.conf;
  # include /etc/nginx/sites-enabled/*;

  #──────────────────────────────────────────────────────────────
  # WebSocket upgrade mapping
  #──────────────────────────────────────────────────────────────
  map $http_upgrade $connection_upgrade {
    default upgrade;
    "" close;
  }

  #──────────────────────────────────────────────────────────────
  # Server for classic.pokepc.net
  #──────────────────────────────────────────────────────────────
  server {
    listen 4000;
    server_name _; # wildcard

    root /webapp/public;
    index index.html;


    # next/_static files
    location ~ ^/(_next/static)/ {
      try_files $uri @ssr;

      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      
      access_log off;
    }

    #──────────────────────────────────────────────────────────────
    # Static files from /public served at root (1y cache)
    #──────────────────────────────────────────────────────────────
    location ~* \.(?:css|js|mjs|json|png|jpg|jpeg|gif|webp|svg|avif|woff2?|ttf|otf|txt|map|ico|aac|xml)$ {
      try_files $uri @ssr;

      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      
      access_log off;
    }

    #──────────────────────────────────────────────────────────────
    # Static files from a .well-known/ directory served at root (1y cache)
    #──────────────────────────────────────────────────────────────
    location ~* \.well-known/ {
      try_files $uri @ssr;
      
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      
      access_log off;
    }

    #──────────────────────────────────────────────────────────────
    # Default route: try static file, else SSR fallback
    #──────────────────────────────────────────────────────────────
    location / {
      try_files $uri @ssr;
      
      access_log off;
    }

    location @ssr {
      proxy_pass http://localhost:3000;
      # proxy_pass http://ssr_app;

      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_read_timeout 65s;
      proxy_send_timeout 65s;

      access_log off;
    }

    #──────────────────────────────────────────────────────────────
    # Nginx Health check endpoint .
    #──────────────────────────────────────────────────────────────
    location = /proxyhealth {
      add_header Content-Type text/plain;
      return 200 "OK\n";
      
      access_log off;
    }
  }
}
